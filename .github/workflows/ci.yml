name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # Detect project structure and determine what to build
  detect:
    name: ðŸ” Detect Project Structure
    runs-on: ubuntu-latest
    outputs:
      has-root-package: ${{ steps.detect.outputs.has-root-package }}
      has-frontend: ${{ steps.detect.outputs.has-frontend }}
      has-backend: ${{ steps.detect.outputs.has-backend }}
      has-shared: ${{ steps.detect.outputs.has-shared }}
      is-monorepo: ${{ steps.detect.outputs.is-monorepo }}
      package-manager: ${{ steps.detect.outputs.package-manager }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect project structure
        id: detect
        run: |
          echo "has-root-package=$([ -f package.json ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has-frontend=$([ -f frontend/package.json ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has-backend=$([ -f backend/package.json ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has-shared=$([ -f shared/package.json ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "is-monorepo=$([ -f frontend/package.json ] || [ -f backend/package.json ] || [ -f shared/package.json ] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          
          # Detect package manager
          if [ -f pnpm-lock.yaml ]; then
            echo "package-manager=pnpm" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "package-manager=yarn" >> $GITHUB_OUTPUT
          elif [ -f package-lock.json ]; then
            echo "package-manager=npm" >> $GITHUB_OUTPUT
          else
            echo "package-manager=none" >> $GITHUB_OUTPUT
          fi

  # Setup and install dependencies
  setup:
    name: ðŸ“¦ Setup Dependencies
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.package-manager != 'none'
    strategy:
      matrix:
        include:
          - workspace: root
            condition: ${{ needs.detect.outputs.has-root-package == 'true' }}
          - workspace: frontend
            condition: ${{ needs.detect.outputs.has-frontend == 'true' }}
          - workspace: backend
            condition: ${{ needs.detect.outputs.has-backend == 'true' }}
          - workspace: shared
            condition: ${{ needs.detect.outputs.has-shared == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        if: needs.detect.outputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        if: needs.detect.outputs.package-manager == 'pnpm'
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        if: needs.detect.outputs.package-manager == 'pnpm'
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        if: matrix.condition == 'true'
        run: |
          if [ "${{ matrix.workspace }}" != "root" ]; then
            cd ${{ matrix.workspace }}
          fi
          
          case "${{ needs.detect.outputs.package-manager }}" in
            "pnpm")
              pnpm install --frozen-lockfile
              ;;
            "yarn")
              yarn install --frozen-lockfile
              ;;
            "npm")
              npm ci
              ;;
          esac

  # Lint and type checking
  lint:
    name: ðŸ” Lint & Type Check
    runs-on: ubuntu-latest
    needs: [detect, setup]
    if: needs.detect.outputs.package-manager != 'none'
    strategy:
      matrix:
        include:
          - workspace: root
            condition: ${{ needs.detect.outputs.has-root-package == 'true' }}
          - workspace: frontend
            condition: ${{ needs.detect.outputs.has-frontend == 'true' }}
          - workspace: backend
            condition: ${{ needs.detect.outputs.has-backend == 'true' }}
          - workspace: shared
            condition: ${{ needs.detect.outputs.has-shared == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        if: needs.detect.outputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        if: needs.detect.outputs.package-manager == 'pnpm'
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        if: needs.detect.outputs.package-manager == 'pnpm'
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        if: matrix.condition == 'true'
        run: |
          if [ "${{ matrix.workspace }}" != "root" ]; then
            cd ${{ matrix.workspace }}
          fi
          
          case "${{ needs.detect.outputs.package-manager }}" in
            "pnpm")
              pnpm install --frozen-lockfile
              ;;
            "yarn")
              yarn install --frozen-lockfile
              ;;
            "npm")
              npm ci
              ;;
          esac

      - name: Run linting
        if: matrix.condition == 'true'
        run: |
          if [ "${{ matrix.workspace }}" != "root" ]; then
            cd ${{ matrix.workspace }}
          fi
          
          case "${{ needs.detect.outputs.package-manager }}" in
            "pnpm")
              pnpm run lint || echo "No lint script found"
              ;;
            "yarn")
              yarn lint || echo "No lint script found"
              ;;
            "npm")
              npm run lint || echo "No lint script found"
              ;;
          esac

      - name: Run type checking
        if: matrix.condition == 'true'
        run: |
          if [ "${{ matrix.workspace }}" != "root" ]; then
            cd ${{ matrix.workspace }}
          fi
          
          case "${{ needs.detect.outputs.package-manager }}" in
            "pnpm")
              pnpm run typecheck || pnpm run tsc || echo "No typecheck script found"
              ;;
            "yarn")
              yarn typecheck || yarn tsc || echo "No typecheck script found"
              ;;
            "npm")
              npm run typecheck || npm run tsc || echo "No typecheck script found"
              ;;
          esac

  # Run tests
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: [detect, setup]
    if: needs.detect.outputs.package-manager != 'none'
    strategy:
      matrix:
        include:
          - workspace: root
            condition: ${{ needs.detect.outputs.has-root-package == 'true' }}
          - workspace: frontend
            condition: ${{ needs.detect.outputs.has-frontend == 'true' }}
          - workspace: backend
            condition: ${{ needs.detect.outputs.has-backend == 'true' }}
          - workspace: shared
            condition: ${{ needs.detect.outputs.has-shared == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        if: needs.detect.outputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        if: needs.detect.outputs.package-manager == 'pnpm'
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        if: needs.detect.outputs.package-manager == 'pnpm'
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        if: matrix.condition == 'true'
        run: |
          if [ "${{ matrix.workspace }}" != "root" ]; then
            cd ${{ matrix.workspace }}
          fi
          
          case "${{ needs.detect.outputs.package-manager }}" in
            "pnpm")
              pnpm install --frozen-lockfile
              ;;
            "yarn")
              yarn install --frozen-lockfile
              ;;
            "npm")
              npm ci
              ;;
          esac

      - name: Run tests
        if: matrix.condition == 'true'
        run: |
          if [ "${{ matrix.workspace }}" != "root" ]; then
            cd ${{ matrix.workspace }}
          fi
          
          case "${{ needs.detect.outputs.package-manager }}" in
            "pnpm")
              pnpm test || echo "No test script found"
              ;;
            "yarn")
              yarn test || echo "No test script found"
              ;;
            "npm")
              npm test || echo "No test script found"
              ;;
          esac

      - name: Upload test results
        if: matrix.condition == 'true' && always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.workspace }}
          path: |
            ${{ matrix.workspace == 'root' && '.' || matrix.workspace }}/coverage
            ${{ matrix.workspace == 'root' && '.' || matrix.workspace }}/test-results
            ${{ matrix.workspace == 'root' && '.' || matrix.workspace }}/artifacts

  # Build project
  build:
    name: ðŸ—ï¸ Build Project
    runs-on: ubuntu-latest
    needs: [detect, setup, lint, test]
    if: needs.detect.outputs.package-manager != 'none'
    strategy:
      matrix:
        include:
          - workspace: root
            condition: ${{ needs.detect.outputs.has-root-package == 'true' }}
          - workspace: frontend
            condition: ${{ needs.detect.outputs.has-frontend == 'true' }}
          - workspace: backend
            condition: ${{ needs.detect.outputs.has-backend == 'true' }}
          - workspace: shared
            condition: ${{ needs.detect.outputs.has-shared == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        if: needs.detect.outputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        if: needs.detect.outputs.package-manager == 'pnpm'
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        if: needs.detect.outputs.package-manager == 'pnpm'
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        if: matrix.condition == 'true'
        run: |
          if [ "${{ matrix.workspace }}" != "root" ]; then
            cd ${{ matrix.workspace }}
          fi
          
          case "${{ needs.detect.outputs.package-manager }}" in
            "pnpm")
              pnpm install --frozen-lockfile
              ;;
            "yarn")
              yarn install --frozen-lockfile
              ;;
            "npm")
              npm ci
              ;;
          esac

      - name: Build project
        if: matrix.condition == 'true'
        run: |
          if [ "${{ matrix.workspace }}" != "root" ]; then
            cd ${{ matrix.workspace }}
          fi
          
          case "${{ needs.detect.outputs.package-manager }}" in
            "pnpm")
              pnpm run build || echo "No build script found"
              ;;
            "yarn")
              yarn build || echo "No build script found"
              ;;
            "npm")
              npm run build || echo "No build script found"
              ;;
          esac

      - name: Upload build artifacts
        if: matrix.condition == 'true' && always()
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ matrix.workspace }}
          path: |
            ${{ matrix.workspace == 'root' && '.' || matrix.workspace }}/dist
            ${{ matrix.workspace == 'root' && '.' || matrix.workspace }}/build
            ${{ matrix.workspace == 'root' && '.' || matrix.workspace }}/out
            ${{ matrix.workspace == 'root' && '.' || matrix.workspace }}/.next

  # Security scan
  security:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: [detect, setup]
    if: needs.detect.outputs.package-manager != 'none'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        if: needs.detect.outputs.package-manager == 'pnpm'
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        if: needs.detect.outputs.package-manager == 'pnpm'
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        if: needs.detect.outputs.package-manager == 'pnpm'
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: |
          case "${{ needs.detect.outputs.package-manager }}" in
            "pnpm")
              pnpm install --frozen-lockfile
              ;;
            "yarn")
              yarn install --frozen-lockfile
              ;;
            "npm")
              npm ci
              ;;
          esac

      - name: Run security scan
        run: |
          # Run dependency audit
          case "${{ needs.detect.outputs.package-manager }}" in
            "pnpm")
              pnpm audit --audit-level=moderate || echo "Audit completed with findings"
              ;;
            "yarn")
              yarn audit --level moderate || echo "Audit completed with findings"
              ;;
            "npm")
              npm audit --audit-level=moderate || echo "Audit completed with findings"
              ;;
          esac

      - name: Run custom security scan
        run: |
          if [ -f scripts/security-scan ]; then
            chmod +x scripts/security-scan
            ./scripts/security-scan || echo "Security scan completed with findings"
          else
            echo "No custom security scan script found"
          fi

  # Summary job
  summary:
    name: ðŸ“Š CI Summary
    runs-on: ubuntu-latest
    needs: [detect, setup, lint, test, build, security]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate CI summary
        run: |
          echo "## ðŸš€ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Detect Project Structure | ${{ needs.detect.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Setup Dependencies | ${{ needs.setup.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Lint & Type Check | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Run Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build Project | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ Security Scan | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Project Structure" >> $GITHUB_STEP_SUMMARY
          echo "- Root Package: ${{ needs.detect.outputs.has-root-package }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.detect.outputs.has-frontend }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.detect.outputs.has-backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- Shared: ${{ needs.detect.outputs.has-shared }}" >> $GITHUB_STEP_SUMMARY
          echo "- Monorepo: ${{ needs.detect.outputs.is-monorepo }}" >> $GITHUB_STEP_SUMMARY
          echo "- Package Manager: ${{ needs.detect.outputs.package-manager }}" >> $GITHUB_STEP_SUMMARY