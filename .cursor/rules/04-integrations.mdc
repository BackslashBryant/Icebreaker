---
description: "MCP Integrations – Supabase, Playwright, Desktop Commander, Vercel, Filesystem, Time"
globs: ["**/*"]
alwaysApply: true
---

# MCP Integrations

These MCP servers are accelerators—not autopilot. Use them when they reduce risk, cite outputs when they influence a decision, and fall back to the CLI only when the MCP path is blocked.

## Principles
- Stay in ticket scope. Propose the exact command/query before running it and wait for approval.
- Prefer scripted helpers (see `tools/` and `examples/automation/`) so operations are reproducible.
- Log meaningful results (links, summaries, screenshots) in issue-specific research files (`docs/research/Issue-<#>-research.md`), `artifacts/`, or the relevant doc.
- If an MCP fails twice, document it in `Docs/plans/Issue-<#>-plan-status-<STATUS>.md` and suggest the fallback.

## When to Reach for Which Tool
- **Web Search** (built-in tool) – Documentation search for APIs, libraries, services. Use for finding official docs, Stack Overflow, etc. Cite sources in issue-specific research files (`docs/research/Issue-<#>-research.md`).
  - **Use Case**: Documentation search, finding official docs, Stack Overflow, etc.
  - **Requires**: No configuration needed
- **Playwright MCP** (`@playwright/mcp`) – UI screenshots, axe/Lighthouse accessibility/perf checks. Attach outputs to the ticket or artifacts.
  - **Requires**: `GITHUB_TOKEN` environment variable
- **Supabase MCP** (`supabase-mcp`) – Database schema diffs, SQL experiments, policy checks. Update `docs/ConnectionGuide.md` when endpoints change.
  - **Requires**: `SUPABASE_URL` and `SUPABASE_ANON_KEY` environment variables
  - **Note**: Access tokens (`sbp_...`) are different from anon keys (`eyJ...`). MCP needs anon key, not access token.
- **Desktop Commander MCP** (`@wonderwhy-er/desktop-commander`) – Local shell/file automation aligned with the allowlist in `.cursor/tools/policy.md`. Provides filesystem operations, process management, and search capabilities.
  - **Requires**: `GITHUB_TOKEN` environment variable
  - **Use Case**: File operations, directory listings, process management, code search
  - **Note**: Can be used instead of Filesystem MCP for file operations
  - **Fallback**: Manual terminal operations
- **Time MCP** (`mcp-server-time`) – Get current time, convert timezones, format dates. **MANDATORY for date/timestamp operations** - use Time MCP to get accurate current dates/times instead of guessing or using system date.
  - **Requires**: `uvx` (uv package manager) or Python 3.10+ with pip
  - **Use Case**: When recording dates in CHANGELOG entries, process improvement entries, completion dates, or any timestamped documentation
  - **CRITICAL DATE RULE**: **NEVER guess dates or use placeholder dates**. Before adding ANY date to ANY file:
    1. **First**: Try Time MCP to get current date/time
    2. **If Time MCP unavailable**: Use system date command (`powershell -Command "Get-Date -Format 'yyyy-MM-dd'"` on Windows, `date +%Y-%m-%d` on Unix)
    3. **Verify**: Confirm the date is correct before using it
    4. **Never**: Use placeholder dates like "2025-01-27", "2025-01-XX", or future dates
    5. **Never**: Assume or guess the current date
  - **Fallback**: If Time MCP unavailable, use system date/time (but prefer Time MCP for accuracy)

## Plan vs Act Expectations
1. **Plan Mode** – State which MCP you intend to use, the command/query, expected outcome, and rollback. Await approval.
2. **Act Mode** – Execute exactly what was approved. Share the raw output (trimmed) plus a one-line interpretation.
3. **Log** – Place citations or artifacts where the next agent will find them (issue-specific research files `docs/research/Issue-<#>-research.md`, `artifacts/<issue>/…`, README updates via Muse, etc.).

## Health Checks
- Run `npm run preflight` at the start of a session to confirm baseline MCP servers respond.
- Run `npm run mcp:heal` to detect and fix common MCP configuration issues (missing env fields, deprecated Smithery CLI usage).
- `npm run mcp:suggest` highlights additional servers worth enabling; document decisions in `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`.
- Nexus records any credential or config changes in `docs/ConnectionGuide.md` before closing a task.

## Important Notes
- **Smithery CLI Deprecated**: As of September 2025, Smithery discontinued STDIO support. All MCP servers now use direct npm package installations (`npx -y <package>`), not `@smithery/cli run`.
- **Environment Variables**: Must be set as User-level variables in Windows (not just session variables) for Cursor to access them. Use `npm run mcp:load-env:win` to load from `.env` file.
- **Supabase Keys**: Access tokens (`sbp_...`) are for Management API, not MCP. MCP requires `SUPABASE_ANON_KEY` (starts with `eyJ...`) from dashboard Settings → API.

## GitHub API Usage (REST API Primary)

**CRITICAL**: All GitHub API operations use REST API as primary method (not GraphQL). Tools automatically retrieve tokens from GitHub CLI keyring first, then fall back to env vars.

**Pattern**:
- **Node.js scripts**: Use `tools/lib/github-api.mjs` utilities (`getRepo()`, `createIssue()`, `listIssues()`, etc.)
- **Token retrieval**: Automatic via `getGitHubToken()` - tries `gh auth token` first, then `GITHUB_TOKEN` env var
- **API method**: REST API (`/repos/{owner}/{repo}/issues`, etc.) - more reliable than GraphQL
- **Do NOT**: Set `GITHUB_TOKEN` in `.env` file - it interferes with GitHub CLI authentication

**Tools using this pattern**:
- `tools/verify-github-issue.mjs` - Issue number verification
- `tools/github-issue.mjs` - Issue creation
- `tools/github-pr.mjs` - Pull request creation
- `tools/github-init-issues.mjs` - Initial issue seeding
- `tools/github-labels.mjs` - Label synchronization

**If authentication fails**: Run `tools/fix-github-auth.ps1` to clear conflicting env vars and re-authenticate.

## Fallback Protocol
1. Pause and report the outage (include the MCP name and error).
2. **For GitHub operations**: 
   - **Node.js scripts**: Use `tools/lib/github-api.mjs` (REST API, automatic token from keyring)
   - **CLI operations**: Use `gh` CLI directly (`gh issue comment`, `gh issue edit`, etc.)
   - **If authentication fails**: Run `tools/fix-github-auth.ps1` to fix auth issues
3. Suggest an approved fallback (CLI, SDK, manual step) if it stays within scope.
4. Capture the variance in the plan or Current Issues log so future runs know why the MCP was skipped.

Treat MCP usage with the same care as code changes—propose, approve, execute, and document.
