---
description: "GitHub-first sequential Agent workflow"
globs: ["**/*"]
alwaysApply: true
---

# GitHub-Centric Workflow

This repo assumes GitHub hosts the project, issues drive the work, and Cursor Agents execute sequentially. Every contribution should leave an auditable trail in GitHub (issues, branches, PRs, checks) and must respect the Plan Mode → Act Mode checkpoints defined in `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`.

## 0. Start From a GitHub Issue
- Before anything else, confirm `docs/vision.md` and `docs/ConnectionGuide.md` are current.
- Every feature, bug, or spike starts as an Issue.
- If none exists, open one with the appropriate template (`/.github/ISSUE_TEMPLATE/`).
- **MANDATORY**: Before creating a GitHub issue, verify issue number doesn't conflict:
  1. Run `node tools/verify-github-issue.mjs` to check next available issue number
  2. Query GitHub API to confirm highest issue number
  3. If creating multiple issues, verify sequential numbering won't conflict
- **MANDATORY**: After creating issue, immediately create `Docs/plans/Issue-<#>-plan-status-IN-PROGRESS.md` with correct issue number
- **MANDATORY**: If issue number changes or conflicts are discovered, update all references in docs immediately
- Reference the issue URL in `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`, commits, and PR description.

## 0.5. Research (Scout) - MANDATORY FIRST STEP
- **MANDATORY**: Scout must research the feature/issue BEFORE planning begins.
- Research goes directly into the plan-status file's **Research Summary** section (NOT a separate file).
- Include: Research question, constraints, sources & findings, recommendations, rollback options.
- **PAUSE**: Research must be complete and documented before Vector creates plan.
- **NO EXCEPTIONS**: Do not proceed to planning without completed research in the plan file.

## 1. Plan (Vector) - MANDATORY AFTER RESEARCH
- **MANDATORY**: Vector must wait for Scout's research to be complete.
- Reference Scout's research file: `docs/research/Issue-<#>-research.md`
- Use Cursor Plan Mode with the issue context plus `docs/vision.md` and research findings.
- **CRITICAL**: Create ONE living document: `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`
  - **Filename Format**: `Issue-<#>-plan-status-<STATUS>.md` where STATUS is one of: `IN-PROGRESS`, `COMPLETE`, `BLOCKED`, `CANCELLED`
  - **Status in Filename**: The filename MUST include the current status. When status changes, rename the file accordingly.
  - **Research Summary**: This file MUST contain the FULL research summary inline (Research Question, Constraints, Sources & Findings, Recommendations Summary, Rollback Options). Do NOT just reference the research file - include the complete research content.
  - This file contains: Research summary (full inline), Plan steps, Status tracking, Current Issues
  - **DO NOT** create separate step files (step1-*.md, step2-*.md, etc.)
  - **DO NOT** create separate status files beyond the plan-status file
  - Update this single file as work progresses
  - When status changes, rename the file to reflect new status (e.g., `Issue-10-plan-status-IN-PROGRESS.md` → `Issue-10-plan-status-COMPLETE.md`)
- Add labels: `agent:vector`, relevant implementer labels, and `status:plan`.
- **PAUSE**: Plan must be reviewed by team before implementation begins.
- **NO EXCEPTIONS**: Do not proceed to implementation without team review of plan.

## 1.5. Team Review - MANDATORY BEFORE EXECUTION
- **MANDATORY**: All agents review the plan and provide notes/feedback.
- Vector coordinates team review session.
- Address any concerns or gaps before proceeding.
- **CRITICAL CHECKPOINT**: Update the plan-status file's **Team Review** section to show "✅ APPROVED" with all agent approvals.
- **PAUSE**: Implementation cannot begin until plan shows "Team review complete - approved for implementation."
- **NO EXCEPTIONS**: Do not proceed to implementation without team approval documented in plan file.
- **VERIFICATION**: Before starting implementation, verify plan-status file shows team approval. If missing, STOP and coordinate team review.

## 1.5. Non-App Logic Changes Policy

**CRITICAL**: All non-app logic files MUST be committed to `main` branch, not feature branches. These files apply universally across all branches.

**Non-App Logic Files** (go to `main`):
- `.cursor/rules/*` (all rule files)
- `.cursor/templates/*` (templates)
- `.cursor/mcp.json` (MCP server configuration)
- `.cursor/config.json` (Cursor configuration, if exists)
- `tools/**/*` (all tool scripts)
- Workflow documentation (`Docs/migration/*`, `.notes/features/README.md`)

**App Logic Files** (go to feature branches):
- `frontend/**/*`, `backend/**/*`, `src/**/*` (application code)
- `docs/Plan.md`, `Docs/plans/Issue-<#>-plan-status-<STATUS>.md` (plan files)
- `docs/research/Issue-<#>-research.md` (research files)
- `.notes/features/<slug>/**` (feature-specific notes)

**Workflow for Non-App Logic Changes**:
1. **MANDATORY PRE-FLIGHT**: Before modifying non-app logic files, verify you're on `main` branch:
   - Run `git branch --show-current` - must show `main`
   - If not on `main`: `git checkout main && git pull origin main`
2. Create branch: `chore/workflow-<description>` OR commit directly to `main`
3. Make changes to non-app logic files
4. Commit with message: `chore: <description of workflow change>`
5. Merge to `main` immediately (these are universal improvements)
6. **CRITICAL**: DO NOT commit non-app logic changes on feature branches
   - Guard: `tools/check-nonapp-branch.mjs` (invoked via pre-commit hook) blocks commits when these files are staged off `main`. Run `npm run agents:install-hook` after pulling to ensure hooks are installed.

**Feature Branch Sync**:
- Before starting work on a feature branch, sync with `main`: `git merge main` or `git rebase main`
- This ensures feature branches inherit latest workflow/configuration changes

**File Categorization Helper**:
- **MANDATORY**: Before committing, run `node tools/categorize-files.mjs --status` to check file categorization
- This tool automatically categorizes files as:
  - **General improvements** (tools, workflow rules, configs) → must go to `main`
  - **Issue-specific** (plans, research, feature code) → must go to feature branch
- **If mixed files detected**: Separate into two commits:
  1. Commit general improvements to `main` first
  2. Then commit issue-specific files to feature branch
- **Workflow**:
  1. Run `node tools/categorize-files.mjs --status` to see categorization
  2. If general improvements detected on feature branch:
     - Stash or commit issue-specific files first
     - Switch to `main`: `git checkout main`
     - Commit general improvements: `git add <general-files> && git commit -m "chore: ..."`
     - Push to main: `git push origin main`
     - Switch back to feature branch: `git checkout <feature-branch>`
     - Merge main: `git merge main`
  3. Then commit issue-specific files to feature branch

## 2. Branching & MCP Setup
- **MANDATORY**: Create branch with format `agent/<agent>/<issue>-<slug>` (e.g. `agent/link/1234-header`) **BEFORE starting any work**. Check current branch matches the issue being worked on. If on wrong branch, create correct branch and move commits.
- **CRITICAL**: Before ANY git operation (add, commit, push), verify:
  1. Current directory is the project root (contains `.git` folder)
  2. **Git Root Validation**: Run `git rev-parse --show-toplevel` and verify it returns the project root (should contain `docs/vision.md`, `tools/preflight.mjs`). If it returns a parent directory (e.g., `C:/Users/OrEo2`), there's a stray `.git` folder - use `tools/get-project-root.mjs` helper instead
  3. **If modifying non-app logic files**: Current branch must be `main` (see Non-App Logic Changes Policy above)
  4. **If modifying app logic files**: Current branch matches the issue being worked on (check with `git branch --show-current`)
  5. If directory is wrong, navigate to project root: Use `node tools/get-project-root.mjs` to get reliable project root, then `cd` to that path
  6. If branch is wrong, create correct branch or switch: `git checkout -b agent/<agent>/<issue>-<slug>` OR `git checkout main` (for non-app logic)
- **NEVER** run git commands from parent directories or outside the repository
- **Git Root Helper**: Use `node tools/get-project-root.mjs` when `git rev-parse --show-toplevel` returns unexpected results (validates project markers to ensure correct root)
- Branch name format: `agent/<agent>/<issue>-<slug>` (e.g. `agent/link/1234-header`).
- **GitHub Authentication & API Usage**: 
  - **PRIMARY METHOD**: Use REST API via `tools/lib/github-api.mjs` utilities. All GitHub tools (`verify-github-issue.mjs`, `github-issue.mjs`, `github-pr.mjs`, etc.) use REST API as primary method.
  - **Token Retrieval**: Tools automatically get token from GitHub CLI keyring first (`gh auth token`), then fall back to `GITHUB_TOKEN` env var if needed. This prevents issues with expired/invalid env vars.
  - **Setup**: Run `gh auth login` once to authenticate. GitHub CLI stores token in keyring securely.
  - **For MCP servers**: Other MCP servers (Desktop Commander, Playwright) may need `GITHUB_TOKEN` environment variable. Get token from GitHub CLI: `gh auth token` and set it as `GITHUB_TOKEN` environment variable (User-level on Windows). This is a one-time setup.
  - **If authentication fails**: Run `tools/fix-github-auth.ps1` to clear conflicting env vars and re-authenticate.
- **GitHub Operations**: 
  - **For Node.js scripts**: Use `tools/lib/github-api.mjs` utilities (REST API, automatic token from keyring).
  - **For CLI operations**: Use `gh` CLI directly for simple operations (`gh issue comment`, `gh issue edit`, etc.).
  - **MANDATORY**: Before running ANY `gh` CLI command, clear `GITHUB_TOKEN` env var if set: `$env:GITHUB_TOKEN = $null` (PowerShell) or `unset GITHUB_TOKEN` (bash). This ensures GitHub CLI uses keyring authentication instead of potentially expired/invalid env var tokens.
  - **Examples**: 
    - PowerShell: `$env:GITHUB_TOKEN = $null; gh issue comment 10 --body "..."` 
    - Bash: `unset GITHUB_TOKEN && gh issue comment 10 --body "..."`
    - Node.js: `node tools/verify-github-issue.mjs`, `node tools/github-issue.mjs kickoff "Title"`
  - **CRITICAL**: Do NOT set `GITHUB_TOKEN` in `.env` file - it interferes with GitHub CLI authentication. Tools get token from keyring automatically.
  - **CRITICAL**: Always clear `GITHUB_TOKEN` env var before `gh` CLI commands to use keyring authentication (SSH protocol preferred).
- Nexus or the acting human runs `npm run agents:install-hook` to copy the path-scope pre-commit hook locally.
- Run `npm run preflight` before pushing to ensure scaffolding is intact (includes branch name validation).
- Execute `npm run mcp:suggest` after dependency or config changes and note the recommendations in `.notes/` or the active plan; run `npm run mcp:suggest -- --install <id>` to append required servers to `.cursor/mcp.json`.
- Record any new ports, endpoints, or services in `docs/ConnectionGuide.md` immediately.

## 2. Implement (Forge/Link/Glide/Apex/Cider) - MANDATORY AFTER PLAN APPROVAL
- **MANDATORY PRE-FLIGHT CHECKS** (must pass ALL before starting):
  1. Plan-status file exists: `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`
  2. Plan contains **Research Summary** section (not empty)
  3. Plan contains **Team Review** section showing "✅ APPROVED"
  4. Plan explicitly states "Team review complete - approved for implementation"
- **IF ANY CHECK FAILS**: STOP immediately. Do not create, modify, or commit any implementation files. Report which check failed and coordinate with Vector.
- Stay in Plan Mode until the caller says "Proceed." Once approved, execute one checkpoint at a time.
- Work within your agent branch and path scope.
- **MANDATORY BEFORE COMMITTING**: Run `node tools/categorize-files.mjs --status` to check for mixed commits
  - If general improvements detected: Commit them to `main` first, then merge into feature branch
  - Only commit issue-specific files to feature branch
- Commit early/often; reference the issue (`#1234`) in commit messages.
- Run targeted tests right after each change; paste the command/output in chat.
- **CRITICAL**: Update ONLY `Docs/plans/Issue-<#>-plan-status-<STATUS>.md` with progress. When status changes, rename the file to reflect new status.
  - Update status section as steps complete
  - Add to "Current Issues" if blockers occur
  - **DO NOT** create separate step files or status files
- Push directly to GitHub branch (no PR needed). Commit and push when ready.
- Use `gh` CLI for branch creation. Terminal git is used for commits and pushes.

## 4. Verify (Pixel, Muse, Nexus, Sentinel)
- Pixel runs `npm run verify` (or agreed scripts) after every checkpoint; report GREEN/RED with file:line references and repro commands. If red, halt and assign back.
- `npm run verify` surfaces the MCP suggestion summary; log any add/remove actions before marking verification complete.
- Muse updates README/CHANGELOG/docs, cites tests, references `docs/vision.md`, and keeps `docs/ConnectionGuide.md` consistent.
- Nexus confirms GitHub Actions succeeded, configures environment variables/Secrets, and keeps status checks enforced. Record every change in the Connection Guide.
- Sentinel jumps in for auth/secret/PII-sensitive work, leaving notes under `/docs/security/`.

## 4.5. CI Verification Protocol

**MANDATORY**: Before merging any PR or considering work complete:

1. **CI Status Check**:
   - **REQUIRED**: Verify all CI jobs are passing (green) before merging
   - **REQUIRED**: Check GitHub Actions UI or `gh pr checks` for job status
   - **REQUIRED**: Wait for all jobs to complete (not just pending)

2. **Error Investigation**:
   - **REQUIRED**: If any job fails, investigate root cause immediately
   - **REQUIRED**: Check job logs for first error snippet
   - **REQUIRED**: Determine if error is related to your changes or pre-existing infrastructure
   - **REQUIRED**: Fix errors related to your changes before merging
   - **REQUIRED**: Document pre-existing errors separately (don't ignore them)

3. **CI Configuration Verification**:
   - **REQUIRED**: Verify CI jobs have all required dependencies installed
   - **REQUIRED**: For Playwright tests, verify browsers are installed before test execution
   - **REQUIRED**: Verify project names in Playwright config match matrix values
   - **REQUIRED**: Verify test commands use correct project flags

4. **Terminal Error Handling**:
   - **REQUIRED**: Never ignore terminal errors or non-zero exit codes
   - **REQUIRED**: Read error messages completely - don't skip or truncate
   - **REQUIRED**: Investigate root cause before proceeding
   - **REQUIRED**: Fix or document all errors before merging

**NEVER**: 
- Merge PRs with failing CI checks (unless explicitly approved for known issues)
- Ignore terminal errors as "display issues" without verification
- Skip browser installation "to save time" in CI jobs
- Proceed with work when CI jobs are failing

**ALWAYS**:
- Wait for CI to complete before merging
- Investigate failing jobs
- Fix errors related to your changes
- Document pre-existing issues separately

## 5. Direct Commits (No PRs)
- Direct commits to feature branches. No PRs needed.
- Commit messages should reference the issue: `feat: Complete Issue #X - [description]`
- **MANDATORY PRE-COMMIT CHECKS** (must pass ALL before committing):
  1. Verify current directory is project root: Run `git rev-parse --show-toplevel` and ensure you're in that directory
  2. Verify current branch matches issue: Run `git branch --show-current` and confirm branch name contains issue number
  3. Verify no parent directory scanning: `git status` should NOT show files outside the repository
  4. If ANY check fails: Navigate to project root with `cd "$(git rev-parse --show-toplevel)"` and re-verify
- Always ask before pushing (per agent rules).

## 6. Close the Loop
- **Issue completion checklist** (must complete all - NO EXCEPTIONS):
  1. **MANDATORY**: Update `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`:
     - Mark ALL steps as ✅ COMPLETE with completion date
     - Update status field to `complete`
     - **Rename file**: Change filename from `Issue-<#>-plan-status-IN-PROGRESS.md` to `Issue-<#>-plan-status-COMPLETE.md`
     - Add final issue summary section with status, completion date, branch, commit hash
     - Document verification results (all acceptance tests passed)
     - **CRITICAL**: This must be done BEFORE committing completion
  2. **MANDATORY**: Update `.notes/features/current.json`:
     - Set `status` to `"complete"`
     - Update `branch` to actual branch name (not "main")
     - Update `note` with completion summary and next steps
     - **CRITICAL**: This must be done BEFORE committing completion
  2.5. **MANDATORY SYNC VERIFICATION**: Before marking issue complete, verify completion status is synced:
     - **Verify plan-status file on main**: Check that `Docs/plans/Issue-<#>-plan-status-COMPLETE.md` exists on main branch (not just feature branch)
     - **Verify status is COMPLETE**: Plan file status must be "COMPLETE" (not "TESTING COMPLETE", "READY FOR VERIFICATION", or "IN-PROGRESS")
     - **Sync plan file to main**: If plan file only exists on feature branch, copy it to main: `git checkout main; git checkout <branch> -- Docs/plans/Issue-<#>-plan-status-COMPLETE.md; git commit`
     - **Run verification**: `node tools/verify-completion-sync.mjs` must pass before considering issue complete
     - **CRITICAL**: This prevents confusion about what's actually complete - plan files on main are source of truth
  3. Commit all changes with message referencing issue: `feat: Complete Issue #X - [description]`
     - **Pre-commit Hook Override**: When fixing bugs that cross agent boundaries (e.g., Pixel fixing frontend bugs discovered during testing), use `git commit --no-verify` with a clear message explaining why. This is acceptable for bug fixes that address issues identified in testing/insight reports.
  4. **MANDATORY**: Push to GitHub: Use `node tools/git-push-with-retry.mjs [branch-name]` for automatic retry and DNS error handling
     - **Preferred method**: `node tools/git-push-with-retry.mjs agent/<agent>/<issue>-<slug>`
     - **Fallback**: `git push -u origin agent/<agent>/<issue>-<slug>` (if script unavailable)
     - **If authentication fails**: 
       - Verify GitHub CLI is authenticated: `gh auth status`
       - If not authenticated: `gh auth login`
       - Git uses GitHub CLI's credential helper automatically - no sync needed
     - **If push fails with DNS error** (`getaddrinfo() thread failed`):
       - Script automatically flushes DNS and retries
       - If script unavailable: Restart PC (Windows DNS threading bug)
       - If persists: Use system Git from terminal instead of Cursor's bundled Git
       - Check for third-party firewalls blocking Git
     - **If push fails with 403 error**:
       - Verify token has `repo` scope: `gh auth status`
       - Refresh token: `gh auth refresh -s repo`
       - Ensure branch exists on GitHub FIRST (create via `gh` CLI: `gh repo create-branch BackslashBryant/Icebreaker <branch-name>`)
     - **If push fails with "branch not found"**: Create branch on GitHub FIRST via `gh` CLI before pushing
     - **DO NOT** ask user for permission - this is a mandatory completion step
  5. **MANDATORY**: Update GitHub issue AND close it: Use `node tools/github-issue-complete.mjs <issue#> [commit-hash]`
     - **Preferred method**: `node tools/github-issue-complete.mjs <issue#>`
     - **Fallback (comment + label + close)**:
       ```
       gh issue comment <issue#> --body "..."
       gh issue edit <issue#> --add-label "status:done"
       gh issue close <issue#> --reason completed
       ```
     - **CRITICAL**: Adding `status:done` and closing are ONE ATOMIC ACTION - never separate them
     - Include: Status summary, branch name, commit hash, test results, files created/modified, next steps
     - Reference plan-status file: `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`
     - **If authentication fails**: Script provides clear error message and fix steps (`gh auth login`)
     - **DO NOT** ask user for permission - this is a mandatory completion step
     - **NEVER leave an issue open with `status:done` label** - if done, it's closed
- Research file already exists at `docs/research/Issue-<#>-research.md` (created during research phase).
- Archive security notes (if any) in `/docs/security/`.
- Update `/docs/agents/KICKOFF.md` sanity checklist if the flow uncovered gaps.
- **CRITICAL**: Never complete an issue without updating plan-status file and current.json FIRST, then pushing commits and updating the GitHub issue. This is mandatory, not optional. These steps should happen automatically without user reminders.
- **PROCESS ENFORCEMENT**: If an issue is marked complete in commit message but plan-status file/current.json show incomplete status, STOP and update status files before proceeding. Status files are the source of truth for issue completion state.
- **DOCUMENTATION GUARDRAIL**: No issue is `status:done` unless:
  1. Matching `Docs/plans/Issue-<#>-plan-status-COMPLETE.md` file exists (not just status field updated)
  2. File is renamed to `-COMPLETE` (follows naming convention: `Issue-<id>-plan-status-<STATE>.md`)
  3. "Outcome" section is complete with all required information (status summary, completion date, branch, commit hash, verification results)
- **TESTING DOCS REQUIREMENT**: When test suites, matrix configurations, or visual snapshots change:
  1. Update `Docs/testing/FLAKY_TESTS.md` if tests are quarantined or retry rules change
  2. Update `Docs/testing/VISUAL-BASELINES.md` if baseline OS/browser matrix or regeneration process changes
  3. Update `Docs/testing/TESTING-BACKLOG.md` if new test ideas are implemented
- **MONITORING DOCS REQUIREMENT**: When CI workflows, health checks, or alerts change:
  1. Update `Docs/monitoring/*` (DASHBOARDS.md, ALERTS.md, RUNBOOK.md) if monitoring/alerting changes
  2. Update `Docs/verification/*` if deployment/rollback procedures or health validation changes
  3. Update `Docs/troubleshooting/*` if incident runbooks or known issues change
- **NO TOP-LEVEL DOC SPRAWL**: No new top-level doc directories; everything goes under `Docs/`. New categories go as subfolders of closest existing area. One-off notes go in `Docs/research/` or `Docs/troubleshooting/` with clear names.

## Tooling & Automation
- `npm run agents:prompt -- all` prints prompt bodies for all agents.
- `npm run agents:install-hook` copies the optional path-scope guard into `.git/hooks`.
- `npm run github:labels` (future helper) will seed repo labels defined in `/docs/github/labels.json`.
- GitHub Actions (`.github/workflows/`) run preflight + `verify-all`. Extend them as the stack evolves.

## Guardrails
- Never merge directly to `main`. Enforce branch protections: require PR, passing checks, linear history.
- Keep secrets in GitHub Actions secrets or environment variables; never commit `.env` files.
- If MCP access changes (new services, revoked tokens), open an issue for Nexus to update `.cursor/config.json` and automation.
- **Repository Mode**: Template repos track Cursor files (`.cursor/`). App repos block them. The pre-commit hook enforces this separation. See `docs/development/SEPARATION.md` for mode conversion and override procedures.
- **Documentation Standards**: See `Docs/README.md` for folder ownership and audience boundaries. All documentation must follow naming conventions in `Docs/plans/README.md`. No new top-level doc directories.

Follow this loop for every change to keep GitHub the source of truth and Cursor Agents accountable.***
