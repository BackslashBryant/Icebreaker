---
description: "GitHub-first sequential Agent workflow"
globs: ["**/*"]
alwaysApply: true
---

# GitHub-Centric Workflow

This repo assumes GitHub hosts the project, issues drive the work, and Cursor Agents execute sequentially. Every contribution should leave an auditable trail in GitHub (issues, branches, PRs, checks) and must respect the Plan Mode → Act Mode checkpoints defined in `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`.

## 0. Start From a GitHub Issue
- Before anything else, confirm `docs/vision.md` and `docs/ConnectionGuide.md` are current.
- Every feature, bug, or spike starts as an Issue.
- If none exists, open one with the appropriate template (`/.github/ISSUE_TEMPLATE/`).
- **MANDATORY**: Before creating a GitHub issue, verify issue number doesn't conflict:
  1. Run `node tools/verify-github-issue.mjs` to check next available issue number
  2. Query GitHub API to confirm highest issue number
  3. If creating multiple issues, verify sequential numbering won't conflict
- **MANDATORY**: After creating issue, immediately create `Docs/plans/Issue-<#>-plan-status-IN-PROGRESS.md` with correct issue number
- **MANDATORY**: If issue number changes or conflicts are discovered, update all references in docs immediately
- Reference the issue URL in `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`, commits, and PR description.

## 0.5. Research (Scout) - MANDATORY FIRST STEP
- **MANDATORY**: Scout must research the feature/issue BEFORE planning begins.
- Research goes directly into the plan-status file's **Research Summary** section (NOT a separate file).
- Include: Research question, constraints, sources & findings, recommendations, rollback options.
- **PAUSE**: Research must be complete and documented before Vector creates plan.
- **NO EXCEPTIONS**: Do not proceed to planning without completed research in the plan file.

## 1. Plan (Vector) - MANDATORY AFTER RESEARCH
- **MANDATORY**: Vector must wait for Scout's research to be complete.
- Reference the Research Summary section inside `Docs/plans/Issue-<#>-plan-status-<STATUS>.md` (Scout keeps it current). No separate research docs exist.
- Use Cursor Plan Mode with the issue context plus `docs/vision.md` and research findings.
- **CRITICAL**: Create ONE living document: `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`
  - **Filename Format**: `Issue-<#>-plan-status-<STATUS>.md` where STATUS is one of: `IN-PROGRESS`, `COMPLETE`, `BLOCKED`, `CANCELLED`
  - **Status in Filename**: The filename MUST include the current status. When status changes, rename the file accordingly.
  - **Header Metadata**: The file header MUST be kept accurate at all times:
    - **Status**: Must match filename status (IN-PROGRESS, COMPLETE, etc.)
    - **Branch**: Must be actual branch name (never "TBD" after branch is created)
    - **Labels**: Must reflect current GitHub issue labels
    - **Created/Completed**: Must include accurate dates
  - **Research Summary**: This file MUST contain the FULL research summary inline (Research Question, Constraints, Sources & Findings, Recommendations Summary, Rollback Options). Do NOT just reference the research file - include the complete research content.
  - This file contains: Research summary (full inline), Plan steps, Status tracking, Current Issues
  - **DO NOT** create separate step files (step1-*.md, step2-*.md, etc.)
  - **DO NOT** create separate status files beyond the plan-status file
  - Update this single file as work progresses
  - **MANDATORY**: When status changes, use `git mv` to rename the file (e.g., `git mv Issue-10-plan-status-IN-PROGRESS.md Issue-10-plan-status-COMPLETE.md`) - this ensures the old file is deleted and only one file exists
  - **MANDATORY**: When renaming, immediately update header metadata (Status, Branch, Labels, Completion date) to match new status
- Add labels: `agent:vector`, relevant implementer labels, and `status:plan`.
- **PAUSE**: Plan must be reviewed by team before implementation begins.
- **NO EXCEPTIONS**: Do not proceed to implementation without team review of plan.

## 1.5. Team Review - MANDATORY BEFORE EXECUTION
- **MANDATORY**: All agents review the plan and provide notes/feedback.
- Vector coordinates team review session.
- Address any concerns or gaps before proceeding.
- **CRITICAL CHECKPOINT**: Update the plan-status file's **Team Review** section to show "✅ APPROVED" with all agent approvals.
- **PAUSE**: Implementation cannot begin until plan shows "Team review complete - approved for implementation."
- **NO EXCEPTIONS**: Do not proceed to implementation without team approval documented in plan file.
- **VERIFICATION**: Before starting implementation, verify plan-status file shows team approval. If missing, STOP and coordinate team review.

## 1.5. Non-App Logic Changes Policy

Use this whenever you're touching shared workflow/config files (rules, tools, automation docs). Issue-specific work (features, plans, research, QA) follows the branch rules in Section 2.

**Default Expectation**: workflow/config changes still *land* on `main`, but you no longer have to context-switch mid-issue. If a tooling tweak is required to finish the current issue, keep it on the `agent/<agent>/<issue>-<slug>` branch, document the change in the plan file, and split the commit before merge.

**Treat these as global files** (double-check scope before merging):
- `.cursor/rules/*`, `.cursor/templates/*`, `.cursor/mcp.json`, `.cursor/config.json`
- `tools/**/*`
- Workflow docs such as `Docs/migration/*`, `.notes/features/README.md`

**Issue-scoped assets**:
- Application code (`frontend/**`, `backend/**`, etc.)
- Plan/status docs (`Docs/plans/Issue-<#>-plan-status-<STATUS>.md`)
- Feature notebooks under `.notes/features/<slug>/**`

**Workflow guardrails**:
1. Keep commits scoped to the active issue; when you introduce a global rule/tool, note it under **Current Issues** or **Next Steps** in the plan.
2. Before merging, run `node tools/categorize-files.mjs --status` and peel off any global-only commits onto `main`.
3. `tools/check-nonapp-branch.mjs` (invoked via the hook) now **warns** instead of blocking; treat the warning as your reminder to split work later.
4. Use clear commit messages (`chore: tighten preflight logging`) so reviewers can cherry-pick the workflow improvements onto `main` when needed.
5. Keep hook scripts installed (`npm run agents:install-hook`) so everyone receives the same warnings.

**Feature Branch Sync**:
- Before starting work on a feature branch, sync with `main`: `git merge main` or `git rebase main`
- This ensures feature branches inherit latest workflow/configuration changes

**File Categorization Helper**:
- **MANDATORY**: Before committing, run `node tools/categorize-files.mjs --status` to check file categorization
- This tool automatically categorizes files as:
  - **General improvements** (tools, workflow rules, configs) → must go to `main`
  - **Issue-specific** (plans, research, feature code) → must go to feature branch
- **If mixed files detected**: Separate into two commits:
  1. Commit general improvements to `main` first
  2. Then commit issue-specific files to feature branch
- **Workflow**:
  1. Run `node tools/categorize-files.mjs --status` to see categorization
  2. If general improvements detected on feature branch:
     - Stash or commit issue-specific files first
     - Switch to `main`: `git checkout main`
     - Commit general improvements: `git add <general-files> && git commit -m "chore: ..."`
     - Push to main: `git push origin main`
     - Switch back to feature branch: `git checkout <feature-branch>`
     - Merge main: `git merge main`
  3. Then commit issue-specific files to feature branch

## 1.6. Verification & No-Verify Automation

- `npm run precommit` now runs `tools/run-precommit.mjs`, which executes the health check, date validator, and lint runner, then writes a log to `artifacts/verification/precommit-<timestamp>.json` (plus `artifacts/verification/latest.json`). Reference that artifact instead of duplicating console output in Markdown.
- When you bypass hooks, include `[no-verify: <reason>]` inside the commit message body. The `post-commit` hook enforces this (empty tags cause the hook to fail) and automatically calls `npm run log:no-verify -- --commit HEAD --reason "..."`, keeping `.notes/no-verify-log.md` synchronized without manual edits.
- Manual verification notes stay in the plan-status file (under **Current Issues**/**Verification Results**). Link to the JSON artifact path when summarizing reruns.

## 2. Branching & MCP Setup
- **MANDATORY**: Pick the right branch mode BEFORE editing:
  - **Non-app logic (Section 1.5)**: stay on `main` or create a short-lived `chore/workflow-<slug>` off `main`, merge immediately.
  - **Issue-specific/app logic**: create `agent/<agent>/<issue>-<slug>` (e.g. `agent/link/1234-header`) and keep it scoped to that issue.
- **CRITICAL**: Before ANY git operation (add, commit, push), verify:
  1. Current directory is the project root (contains `.git` folder)
  2. **Git Root Validation**: Run `git rev-parse --show-toplevel` and verify it returns the project root (should contain `docs/vision.md`, `tools/preflight.mjs`). If it returns a parent directory (e.g., `C:/Users/OrEo2`), there's a stray `.git` folder - use `tools/get-project-root.mjs` helper instead
  3. **If modifying non-app logic files**: Branch should normally be `main`; if the change is tied to the current issue, keep it on `agent/<agent>/<issue>-<slug>` and follow Section 1.5 (document + split before merge)
  4. **If modifying app logic files**: Current branch matches the issue being worked on (check with `git branch --show-current`)
  5. If directory is wrong, navigate to project root: Use `node tools/get-project-root.mjs` to get reliable project root, then `cd` to that path
  6. If branch is wrong, create correct branch or switch: `git checkout -b agent/<agent>/<issue>-<slug>` OR `git checkout main` (for non-app logic)
- **NEVER** run git commands from parent directories or outside the repository
- **Git Root Helper**: Use `node tools/get-project-root.mjs` when `git rev-parse --show-toplevel` returns unexpected results (validates project markers to ensure correct root)
- Branch name format: `agent/<agent>/<issue>-<slug>` (e.g. `agent/link/1234-header`).
- **GitHub authentication & CLI usage**:
  - Use REST helpers in `tools/lib/github-api.mjs`; tokens come from `gh auth token` (keyring) with `GITHUB_TOKEN` as fallback.
  - Always `unset GITHUB_TOKEN`/`$env:GITHUB_TOKEN = $null` before running any `gh ...` command. Never store that token in `.env`.
  - Detailed troubleshooting (auth resets, MCP env wiring, PowerShell fallbacks) lives in `@rules/workflow-appendix`.
- **GitHub Operations**:
  - Node scripts handle automation (`tools/github-*.mjs`), while `gh` CLI covers comments/labels and terminal git handles commits.
  - For fallback commands, environment setup, and push troubleshooting, see `@rules/workflow-appendix`.
- Nexus or the acting human runs `npm run agents:install-hook` to copy the path-scope pre-commit hook locally.
- Run `npm run preflight` before pushing to ensure scaffolding is intact (includes branch name validation).
- Execute `npm run mcp:suggest` after dependency or config changes and note the recommendations in `.notes/` or the active plan; run `npm run mcp:suggest -- --install <id>` to append required servers to `.cursor/mcp.json`.
- Record any new ports, endpoints, or services in `docs/ConnectionGuide.md` immediately.

## 2. Implement (Forge/Link/Glide/Apex/Cider) - MANDATORY AFTER PLAN APPROVAL
- **MANDATORY PRE-FLIGHT CHECKS** (must pass ALL before starting):
  1. Plan-status file exists: `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`
  2. Plan contains **Research Summary** section (not empty)
  3. Plan contains **Team Review** section showing "✅ APPROVED"
  4. Plan explicitly states "Team review complete - approved for implementation"
- **IF ANY CHECK FAILS**: STOP immediately. Do not create, modify, or commit any implementation files. Report which check failed and coordinate with Vector.
- Stay in Plan Mode until the caller says "Proceed." Once approved, execute one checkpoint at a time.
- Work within your agent branch and path scope.
- **MANDATORY BEFORE COMMITTING**: Run `node tools/categorize-files.mjs --status` to check for mixed commits
  - If general improvements detected: Commit them to `main` first, then merge into feature branch
  - Only commit issue-specific files to feature branch
- Commit early/often; reference the issue (`#1234`) in commit messages.
- Run targeted tests right after each change; paste the command/output in chat.
- **CRITICAL**: Update ONLY `Docs/plans/Issue-<#>-plan-status-<STATUS>.md` with progress. When status changes, rename the file to reflect new status.
  - Update status section as steps complete
  - **MANDATORY**: When marking checkpoints complete in Status Tracking, also mark the corresponding plan checkboxes (acceptance criteria) as complete - keep Status Tracking and Plan checkboxes synchronized
  - Add to "Current Issues" if blockers occur
  - **DO NOT** create separate step files or status files
  - **MANDATORY**: Keep header metadata accurate - update Status, Branch, Labels whenever they change
- Push directly to GitHub branch (no PR needed). Commit and push when ready.
- Use `gh` CLI for branch creation. Terminal git is used for commits and pushes.

## 4. Verify (Pixel, Muse, Nexus, Sentinel)
- Pixel runs `npm run verify` (or agreed scripts) after every checkpoint; report GREEN/RED with file:line references and repro commands. If red, halt and assign back.
- `npm run verify` surfaces the MCP suggestion summary; log any add/remove actions before marking verification complete.
- Muse updates README/CHANGELOG/docs, cites tests, references `docs/vision.md`, and keeps `docs/ConnectionGuide.md` consistent.
- Nexus confirms GitHub Actions succeeded, configures environment variables/Secrets, and keeps status checks enforced. Record every change in the Connection Guide.
- Sentinel jumps in for auth/secret/PII-sensitive work, leaving notes under `/docs/security/`.

## 4.5. CI Verification Protocol

**MANDATORY**: Before merging any PR or considering work complete:

1. **CI Status Check**:
   - **REQUIRED**: Verify all CI jobs are passing (green) before merging
   - **REQUIRED**: Check GitHub Actions UI or `gh pr checks` for job status
   - **REQUIRED**: Wait for all jobs to complete (not just pending)

2. **Error Investigation**:
   - **REQUIRED**: If any job fails, investigate root cause immediately
   - **REQUIRED**: Check job logs for first error snippet
   - **REQUIRED**: Determine if error is related to your changes or pre-existing infrastructure
   - **REQUIRED**: Fix errors related to your changes before merging
   - **REQUIRED**: Document pre-existing errors separately (don't ignore them)

3. **CI Configuration Verification**:
   - **REQUIRED**: Verify CI jobs have all required dependencies installed
   - **REQUIRED**: For Playwright tests, verify browsers are installed before test execution
   - **REQUIRED**: Verify project names in Playwright config match matrix values
   - **REQUIRED**: Verify test commands use correct project flags

4. **Terminal Error Handling**:
   - **REQUIRED**: Never ignore terminal errors or non-zero exit codes
   - **REQUIRED**: Read error messages completely - don't skip or truncate
   - **REQUIRED**: Investigate root cause before proceeding
   - **REQUIRED**: Fix or document all errors before merging

**NEVER**:
- Merge PRs with failing CI checks (unless explicitly approved for known issues)
- Ignore terminal errors as "display issues" without verification
- Skip browser installation "to save time" in CI jobs
- Proceed with work when CI jobs are failing

**ALWAYS**:
- Wait for CI to complete before merging
- Investigate failing jobs
- Fix errors related to your changes
- Document pre-existing issues separately

## 5. Direct Commits (No PRs)
- Direct commits to feature branches. No PRs needed.
- Commit messages should reference the issue: `feat: Complete Issue #X - [description]`
- **MANDATORY PRE-COMMIT CHECKS** (must pass ALL before committing):
  1. Verify current directory is project root: Run `git rev-parse --show-toplevel` and ensure you're in that directory
  2. Verify current branch matches issue: Run `git branch --show-current` and confirm branch name contains issue number
  3. Verify no parent directory scanning: `git status` should NOT show files outside the repository
  4. If ANY check fails: Navigate to project root with `cd "$(git rev-parse --show-toplevel)"` and re-verify
- Always ask before pushing (per agent rules).

## 6. Close the Loop
Finish every issue with the seven steps below. The command-level checklist, fallback flows, and troubleshooting live in `@rules/workflow-appendix#issue-completion`.

1. Update `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`: rename to `-COMPLETE`, fill the Outcome + Status Tracking, sync header metadata, and keep Research/Team Review inline. No other planning docs should exist.
2. Update `.notes/features/current.json` with status `"complete"`, the actual branch name, and next-step notes.
3. Log Muse’s UX/doc approval for any work that affects frontend UI, UX copy, or docs: share the latest screenshots/notes with Muse, have them respond with ✅ in chat, and record the approval (name/date + summary) inside the plan file’s Status Tracking or Current Issues section.
4. Commit with the issue reference (`feat: Complete Issue #X - ...`). Only invoke `--no-verify` for cross-agent bug fixes and explain why.
5. Push via `node tools/git-push-with-retry.mjs <branch>` (script handles DNS + auth fallbacks).
6. Comment, label, and close the GitHub issue using `node tools/github-issue-complete.mjs <issue#>` so `status:done` and closure happen atomically.
7. Sync the finalized plan file onto `main` (checkout `main`, pull, copy the plan file from your branch, commit `docs: Add Issue #<#> plan`, push).
8. End on `main`. Feature branches are disposable; prune later if desired.

Never skip these steps. Status files are the source of truth—if the plan file or `current.json` disagree with chat/commits, fix the docs first. Keep testing/monitoring docs in sync when suites, baselines, or health checks change.

## Tooling & Guardrails
- Script references (`npm run agents:*`, GitHub label helpers, CI runners) and repository guardrails (secrets management, template vs app mode, doc ownership) live in `@rules/workflow-appendix`. Pull that file when you need concrete commands or troubleshooting steps.
- Documentation standards still point to `Docs/README.md`; avoid new top-level directories unless the README endorses them.

Follow this loop for every change to keep GitHub the source of truth and Cursor Agents accountable.***
