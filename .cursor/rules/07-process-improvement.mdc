---
description: "Process improvements"
globs: ["**/*"]
alwaysApply: false
---

# Lessons Learned

**Format**: Keep entries to 2-3 sentences max. Include: trigger, lesson, rule update. No verbose sections. Follow `@rules/dates` for timestamp handling (Time MCP first, system date fallback, no placeholders).

## 2025-12-04: GitHub API - Auto-Detect Invalid Tokens and Use SSH for Git

**Trigger**: GitHub API calls failing with 401 errors due to invalid `GITHUB_TOKEN` env var. Git push failures due to authentication confusion. **Lesson**: **MANDATORY** - GitHub API scripts must automatically detect and ignore invalid `GITHUB_TOKEN` env vars. Git operations use SSH automatically via remote URL - no authentication needed. **Rule**: Updated `tools/lib/github-api.mjs` to validate token format and ignore invalid env tokens. Updated `tools/github-issue-complete.mjs` to clear invalid tokens before API calls. Updated `.cursor/rules/01-workflow.mdc` to emphasize API-first approach (never use `gh` CLI directly) and document SSH for git operations. All GitHub operations now use REST API via scripts, not `gh` CLI.

## 2025-11-23: GitHub CLI - Clear GITHUB_TOKEN Before Operations

**Trigger**: GitHub CLI (`gh`) commands failing with 401 errors even when keyring authentication was valid. `GITHUB_TOKEN` environment variable was interfering with GitHub CLI's keyring authentication. **Lesson**: **MANDATORY** - Always clear `GITHUB_TOKEN` env var before running ANY `gh` CLI command. GitHub CLI prioritizes env var tokens over keyring, and env var tokens may be expired/invalid. Clearing the env var forces GitHub CLI to use keyring authentication (SSH protocol preferred). **Rule**: Updated `.cursor/rules/01-workflow.mdc` to require clearing `GITHUB_TOKEN` before `gh` CLI commands: PowerShell `$env:GITHUB_TOKEN = $null; gh ...`, Bash `unset GITHUB_TOKEN && gh ...`. This ensures reliable keyring-based authentication for all GitHub CLI operations.

## 2025-11-11: GitHub API REST Primary & Keyring Authentication

**Trigger**: GitHub CLI GraphQL API failing with 401 errors despite authentication. Tools needed reliable GitHub API access. **Lesson**: REST API is more reliable than GraphQL. Token retrieval should prioritize GitHub CLI keyring (`gh auth token`) over environment variables to avoid expired token issues. Setting `GITHUB_TOKEN` in `.env` file interferes with GitHub CLI authentication. **Rule**: Created `tools/lib/github-api.mjs` with REST API utilities and automatic keyring-first token retrieval. Updated all GitHub tools (`verify-github-issue.mjs`, `github-issue.mjs`, `github-pr.mjs`, `github-init-issues.mjs`, `github-labels.mjs`) to use REST API as primary. Deprecated `tools/sync-github-token.ps1` (causes auth issues). Created `tools/fix-github-auth.ps1` for auth troubleshooting. Updated `.cursor/rules/01-workflow.mdc` and `.cursor/rules/04-integrations.mdc` to document REST API primary pattern and keyring-first token retrieval. **CRITICAL**: Do NOT set `GITHUB_TOKEN` in `.env` file - tools get token from keyring automatically.

## 2025-11-11: Date Verification Guardrails

**Trigger**: Agent used incorrect placeholder dates (2025-01-27) instead of verifying actual current date (2025-11-11). **Lesson**: **NEVER guess dates or use placeholder dates**. Always verify current date first: try Time MCP, if unavailable use system date command (`powershell -Command "Get-Date -Format 'yyyy-MM-dd'"` on Windows), verify date is correct before using. **Rule**: Added mandatory date verification process to `.cursor/rules/04-integrations.mdc`, `.cursor/rules/00-core.mdc`, `.cursor/rules/02-quality.mdc`, `.cursor/rules/07-process-improvement.mdc`, and `.cursor/rules/persona-muse.mdc` - 5-step verification process: try Time MCP → use system date if unavailable → verify → never use placeholders → never guess.

## 2025-11-11: Playwright Test Output Cleanup & Dynamic Workers

**Trigger**: Test output showed Unicode artifacts (Γ£ô, ΓÇ║) and session IDs in PowerShell, making output unreadable. Also using only 1 worker unnecessarily slowed tests. **Lesson**: Use `list` reporter instead of `line` reporter, remove `FORCE_COLOR` env vars (let Playwright handle encoding), use Playwright MCP as primary tool for cleaner output, use dynamic workers (`50%` of CPU cores) instead of hardcoded `workers: 1`. **Rule**: Updated `.cursor/rules/08-testing.mdc` to prioritize Playwright MCP, use `list` reporter, document clean output approach, use `workers: '50%'` for dynamic resource adaptation.

## 2025-11-23: CI Monitoring Protocol

**Trigger**: Agent pushed changes and didn't monitor CI until completion, leading to unknown status and potential merge of failing changes. **Lesson**: **MANDATORY** - Always monitor CI runs until completion. After pushing, check status immediately, poll every 30-60 seconds until `completed`, verify all key jobs pass before proceeding. Never assume CI will pass or skip verification. **Rule**: Added CI Monitoring Protocol to `.cursor/rules/02-quality.mdc` - requires monitoring CI until completion, polling status, verifying all key jobs, and never skipping CI verification before merge or next steps.

## 2025-11-11: GitHub Issue Number Sync

**Trigger**: Issue #11 conflict - main planning issue existed in docs but was never created on GitHub, causing Phase 2 backlog items to get wrong numbers. **Lesson**: Always verify GitHub issue numbers before creating, sync docs immediately after creation, check for conflicts when creating multiple issues. **Rule**: Added mandatory pre-creation verification step in `.cursor/rules/01-workflow.mdc`, created `tools/verify-github-issue.mjs` safeguard script, updated `tools/github-issue.mjs` with pre-check.

## 2025-11-11: GitHub API Authentication Fallback

**Trigger**: GitHub API 401 errors when creating issues via Node.js scripts or `gh` CLI despite token being set. **Lesson**: PowerShell direct API calls reading token from `.env` file are most reliable on Windows - bypass Node.js env var issues and CLI keyring conflicts. **Rule**: Always try PowerShell `Invoke-RestMethod` with token parsed from `.env` as fallback when GitHub operations fail. Pattern codified in `.cursor/rules/01-workflow.mdc` and `.cursor/rules/04-integrations.mdc`.

## 2025-11-10: Missing Dependency Import Crash

**Trigger**: Backend crashed on startup because `@sentry/node` was imported but not installed. **Lesson**: Never use static imports for optional dependencies - use dynamic `import()` with try-catch. **Rule**: Added dependency check to preflight, use dynamic imports for optional packages.

## 2025-11-10: Research Before Fixing

**Trigger**: Agent fixed tests without researching root cause first. **Lesson**: Mandatory research protocol: gather evidence (errors, logs, network) → understand root cause → research solutions → then fix. **Rule**: Added to `.cursor/rules/02-quality.mdc` - never jump to fixes without investigation.

## 2025-11-10: Testing Infrastructure Gaps

**Trigger**: Tests hanging without timeouts, missing security/edge case coverage. **Lesson**: All tests need timeouts, centralized logging, security/edge case tests, performance automation. **Rule**: Created `.cursor/rules/08-testing.mdc` with tool selection and timeout requirements.

## 2025-11-09: Supabase MCP Migration

**Trigger**: Supabase MCP npm package required undocumented `MCP_API_KEY`. **Lesson**: Use official hosted server (`https://mcp.supabase.com/mcp`) - simpler, more secure, browser auth. Access tokens (`sbp_...`) are for Management API, not MCP. MCP requires `SUPABASE_ANON_KEY` (`eyJ...`) from dashboard. **Rule**: Updated `.cursor/mcp.json` to use URL-based config, documented key differences in `.cursor/rules/04-integrations.mdc`.

## 2025-11-10: Issue Completion Protocol

**Trigger**: User had to remind agent to push commits and update GitHub issue. **Lesson**: Completion steps (push, GitHub comment, labels) are mandatory and automatic - no user reminders needed. **Rule**: Updated `.cursor/rules/01-workflow.mdc` Section 6 - automatic completion steps.

## 2025-11-10: Playwright MCP Usage

**Trigger**: Agent used CLI instead of Playwright MCP for accessibility checks. **Lesson**: When MCP is configured, use it for a11y checks, screenshots, Lighthouse - check MCP availability before CLI fallback. **Rule**: Documented in `.cursor/rules/04-integrations.mdc`.

## 2025-11-10: Test Report Auto-Open

**Trigger**: Playwright HTML reports auto-opened, causing hangs. **Lesson**: Configure all reporters with `open: 'never'` and output to `artifacts/`. **Rule**: Updated `tests/playwright.config.ts` with explicit no-auto-open config.

## 2024-12-19: MCP-First Git Operations

**Trigger**: Agent used terminal instead of GitHub MCP for git operations. **Lesson**: Check MCP triggers first - GitHub MCP for branch/PR/issue updates, git CLI for commits. **Rule**: Clarified in `.cursor/rules/04-integrations.mdc`.

## 2025-11-10: No Report Files

**Trigger**: Agent created lengthy report file when user requested QA. **Lesson**: Never create report files - reports in chat only, update GitHub issues/docs directly. **Rule**: Added guardrails to Pixel and Muse personas.

## 2025-11-06: Issue Completion Workflow

**Trigger**: Agent didn't create proper branch or update GitHub issue. **Lesson**: Create branch FIRST (`agent/<agent>/<issue>-<slug>`), then update GitHub issue, commit, push. **Rule**: Enforced in `AGENTS.md` and `.cursor/rules/01-workflow.mdc`.

## 2025-11-11: GitHub MCP Removal

**Trigger**: GitHub MCP caused recurring authentication issues and added complexity. **Lesson**: GitHub CLI (`gh`) handles all GitHub operations reliably without MCP overhead. **Rule**: Removed GitHub MCP from `.cursor/mcp.json`. Updated all rules to use `gh` CLI directly for GitHub operations. Removed GitHub MCP references from documentation.

## 2025-11-11: MCP Environment Variable Management

**Trigger**: MCP servers failing due to environment variables set only in PowerShell session, not User-level. **Lesson**: Windows requires User-level environment variables (not session) for Cursor to access them. Always use `npm run mcp:load-env:win` to load from `.env` file, then restart Cursor completely. **Rule**: Documented in `.cursor/rules/04-integrations.mdc` - env vars must be User-level, always restart Cursor after changes.

## 2025-11-12: Git Push & GitHub Issue Update Self-Resolution

**Trigger**: Git push failed with DNS threading error, pre-commit hook blocked cross-agent bug fixes, GitHub issue update failed with auth errors. Agent had to manually retry and work around issues. **Lesson**: Create automated helpers for common failure modes: DNS errors need retry with DNS flush, pre-commit hook blocks are acceptable for cross-agent bug fixes (use `--no-verify`), GitHub issue updates need better auth error handling. **Rule**: Created `tools/git-push-with-retry.mjs` with automatic DNS flush and retry logic, created `tools/github-issue-complete.mjs` with clear auth error messages, updated `.cursor/rules/01-workflow.mdc` to use these helpers and document `--no-verify` exception for bug fixes. Added npm scripts `git:push` and `github:complete`. Agents now self-resolve these issues automatically.

## 2025-11-11: Git Push Troubleshooting Consolidation

**Trigger**: Multiple troubleshooting files (`git-push-hotwash.md`, `windows-git-push-fix.md`) contained duplicate information that should be in rules. **Lesson**: Troubleshooting knowledge must be codified into workflow rules, not scattered in separate files. **Rule**: Consolidated all git push troubleshooting into `.cursor/rules/01-workflow.mdc` Section 6 with step-by-step solutions for DNS errors, 403 errors, and branch creation. Removed redundant troubleshooting files.

## 2025-11-06: Windows Git Push Issues

**Trigger**: Git push failed with DNS threading error, then 403 after restart. **Lesson**: Create branch on GitHub FIRST via MCP, use system Git if Cursor's bundled Git fails, check token scopes for 403 errors, restart PC for DNS threading bugs. **Rule**: Codified into `.cursor/rules/01-workflow.mdc` Section 6 push troubleshooting steps.

## 2025-11-06: Direct Commits Only

**Trigger**: User prefers direct commits, no PRs. **Lesson**: Always direct commits to feature branches - no PRs ever. **Rule**: Updated `.cursor/rules/01-workflow.mdc` Section 5.

## 2025-11-10: Test Skipping Anti-Pattern

**Trigger**: Tests were skipped instead of fixed when supertest timed out. **Lesson**: Never skip tests - fix root causes or switch to working patterns (use `fetch()` + test server instead of supertest). **Rule**: Updated `.cursor/rules/08-testing.mdc` - never skip, use proven patterns.

## 2025-11-10: Cursor Bundled Git Issues

**Trigger**: Cursor's Git push failed with DNS threading error, system Git worked fine. **Lesson**: When Cursor's bundled Git fails, use system Git from terminal - it works reliably on Windows. **Rule**: Added to troubleshooting docs - use system Git as fallback.

## 2025-11-10: Git Safety Checks

**Trigger**: Git operations attempted from wrong directory, wrong branch detected. **Lesson**: Mandatory checks before ANY git operation: verify project root directory, verify branch matches issue number. **Rule**: Added to `.cursor/rules/01-workflow.mdc` - never run git from parent directories.

## 2025-11-10: Issue Completion Status Tracking

**Trigger**: Issue marked complete in commit but progress.md/current.json showed incomplete. **Lesson**: Status files are source of truth - update progress.md and current.json BEFORE committing completion. **Rule**: Added mandatory status file updates to completion checklist in `.cursor/rules/01-workflow.mdc`.

## 2025-11-10: Smart Process Cleanup

**Trigger**: Process cleanup needed to preserve MCP/Cursor processes while killing project dev servers. **Lesson**: Identify processes by command-line patterns (project path, dev commands) while excluding MCP and Cursor processes. **Rule**: Created smart cleanup script with pattern matching, updated cleanup guidance.

## 2025-11-15: Issue Completion Status Sync Verification

**Trigger**: Confusion about completion status - Issue #6, #21, #26 were complete but plan-status files weren't synced to main, current.json showed wrong status, plan files showed "TESTING COMPLETE" instead of "COMPLETE". **Lesson**: **MANDATORY SYNC CHECKPOINT** - When marking issue complete, must: (1) Verify plan-status file exists on main (not just branch), (2) Update plan-status file status to "COMPLETE" (not "TESTING COMPLETE" or "READY FOR VERIFICATION"), (3) Update current.json to reflect actual completion state, (4) Commit plan-status file to main branch (not just feature branch), (5) Run verification: `node tools/verify-completion-sync.mjs` before considering issue complete. **Rule**: Added mandatory sync verification to `.cursor/rules/01-workflow.mdc` Section 6 - completion checklist now includes "Verify plan-status file synced to main" and "Run completion sync verification". Created `tools/verify-completion-sync.mjs` to check plan files on main match branch status, current.json matches plan files, and all completed issues have COMPLETE plan files on main. Added to pre-commit checks and `npm run verify` suite.

## 2025-11-23: CI Job Configuration & Terminal Error Handling

**Trigger**: CI jobs failing because Playwright browsers weren't installed before running tests. Terminal errors were being dismissed as "display issues" without investigation. **Lesson**: **MANDATORY CI CONFIGURATION** - All CI jobs that run Playwright tests MUST install browsers before test execution. All terminal errors must be investigated - never ignore non-zero exit codes or error messages. Unicode display artifacts (garbled emoji characters) are cosmetic, but actual errors (missing executables, failed commands) must be fixed. **Rule**: Added CI job configuration requirements to `.cursor/rules/02-quality.mdc` (browser installation, dependency checks, project verification) and `.cursor/rules/08-testing.mdc` (Playwright CI configuration patterns). Added terminal error handling protocol to `.cursor/rules/02-quality.mdc` - mandatory error detection, investigation, and resolution. Never ignore errors, always check exit codes, investigate root cause, fix or document all errors before proceeding.

## 2025-11-24: Consolidate All Planning Artifacts into Plan-Status File

**Trigger**: Agent created separate files for research (`docs/research/Issue-<#>-research.md`) and team review approval (`.notes/features/<slug>/team-review-approved.md`) when everything should be inline in the single plan-status file. **Lesson**: **ONE FILE RULE** - All planning artifacts (research, plan steps, team review, status tracking) go into `Docs/plans/Issue-<#>-plan-status-<STATUS>.md`. No separate research files. No separate approval files. The plan-status file is the single source of truth. **Rule**: Updated `.cursor/rules/01-workflow.mdc` to remove separate file requirements. Research goes in Research Summary section. Team review goes in Team Review section. Pre-flight checks verify these sections exist in the plan file, not separate files.

## 2025-11-24: Close Issues When Done

**Trigger**: Multiple issues left open despite having `status:done` label—agent kept forgetting to actually close them on GitHub. User had to manually prompt cleanup. **Lesson**: **MANDATORY** - When adding `status:done` label, immediately close the issue in the same operation. Never leave issues open with `status:done`. The label AND the close are one atomic action. **Rule**: Updated `.cursor/rules/01-workflow.mdc` Section 6 completion checklist to make closing explicit. Pattern: `gh issue close <#> --reason completed --comment "..."` immediately after `gh issue edit <#> --add-label "status:done"`. Never separate these steps.

## 2025-11-25: Workflow Guardrails & Self-Correcting CI

**Trigger**: Issue #15 implementation revealed gaps: duplicate legacy projects causing inflated CI runs, missing mobile WebKit coverage, matrix/config misalignment, no enforcement of job scopes or placeholder data blocking. **Lesson**: **MANDATORY WORKFLOW GUARDRAILS** - Define and enforce job scopes (checks = lint/type/unit only, ban E2E), ensure matrix ≡ config alignment (remove legacy projects when adding new ones), validate browser dependencies per job, block placeholder dates/strings, standardize selectors via central map, enforce snapshot policies, codify flake handling with ownership tracking, require merge base checks before push. **Rule**: Created `.cursor/rules/09-workflow-guardrails.mdc` with comprehensive guardrail definitions. Created validation scripts: `validate-matrix-config.mjs`, `validate-browser-deps.mjs`, `validate-job-scopes.mjs`, `validate-flake-tracking.mjs`, `pre-merge-checklist.mjs`. Enhanced `check-dates.mjs` to detect placeholder strings (TODO/FIXME without issue refs). Updated pre-commit hook to validate matrix/config alignment and browser deps when workflow files change. Updated pre-push hook to check merge base with main and log `--no-verify` usage. All guardrails are self-enforcing via hooks and CI validation.

## 2025-11-26: Plan File Metadata Consistency & Completion Checklist

**Trigger**: Issue #30 completion revealed inconsistencies: plan file header showed "Status: IN-PROGRESS" and "Branch: TBD" even after completion, plan checkboxes remained unchecked despite Status Tracking showing complete, stale IN-PROGRESS file left after renaming to COMPLETE. **Lesson**: **MANDATORY METADATA CONSISTENCY** - Plan file header metadata (Status, Branch, Labels, dates) must always match actual state. When marking checkpoints complete, update BOTH Status Tracking AND plan checkboxes. When renaming plan file, use `git mv` to ensure old file is deleted. When completing issue, update ALL metadata in header (Status to COMPLETE, Branch to actual name, Labels to status:done, add Completion date). **Rule**: Updated `.cursor/rules/01-workflow.mdc` to require: (1) Header metadata kept accurate at all times (never "TBD" after branch created), (2) Plan checkboxes and Status Tracking kept synchronized, (3) Use `git mv` when renaming plan files, (4) Update all header metadata when completing issue, (5) Verify only one plan file exists after renaming. Added to completion checklist: update header metadata, mark all checkboxes, verify no stale files.
