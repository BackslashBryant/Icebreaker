---
description: "Process improvements"
globs: ["**/*"]
alwaysApply: false
---

# Lessons Learned

**Format**: Keep entries to 2-3 sentences max. Include: trigger, lesson, rule update. No verbose sections. **Date format**: **MANDATORY** - **NEVER guess dates or use placeholder dates**. Before adding ANY date to ANY file:
1. **First**: Try Time MCP to get current date/time
2. **If Time MCP unavailable**: Use system date command (`powershell -Command "Get-Date -Format 'yyyy-MM-dd'"` on Windows, `date +%Y-%m-%d` on Unix)
3. **Verify**: Confirm the date is correct before using it
4. **Never**: Use placeholder dates like "2025-01-27", "2025-01-XX", or future dates
5. **Never**: Assume or guess the current date
Format dates as YYYY-MM-DD. Always verify date accuracy before adding entries.

## 2025-11-11: GitHub API REST Primary & Keyring Authentication

**Trigger**: GitHub CLI GraphQL API failing with 401 errors despite authentication. Tools needed reliable GitHub API access. **Lesson**: REST API is more reliable than GraphQL. Token retrieval should prioritize GitHub CLI keyring (`gh auth token`) over environment variables to avoid expired token issues. Setting `GITHUB_TOKEN` in `.env` file interferes with GitHub CLI authentication. **Rule**: Created `tools/lib/github-api.mjs` with REST API utilities and automatic keyring-first token retrieval. Updated all GitHub tools (`verify-github-issue.mjs`, `github-issue.mjs`, `github-pr.mjs`, `github-init-issues.mjs`, `github-labels.mjs`) to use REST API as primary. Deprecated `tools/sync-github-token.ps1` (causes auth issues). Created `tools/fix-github-auth.ps1` for auth troubleshooting. Updated `.cursor/rules/01-workflow.mdc` and `.cursor/rules/04-integrations.mdc` to document REST API primary pattern and keyring-first token retrieval. **CRITICAL**: Do NOT set `GITHUB_TOKEN` in `.env` file - tools get token from keyring automatically.

## 2025-11-11: Date Verification Guardrails

**Trigger**: Agent used incorrect placeholder dates (2025-01-27) instead of verifying actual current date (2025-11-11). **Lesson**: **NEVER guess dates or use placeholder dates**. Always verify current date first: try Time MCP, if unavailable use system date command (`powershell -Command "Get-Date -Format 'yyyy-MM-dd'"` on Windows), verify date is correct before using. **Rule**: Added mandatory date verification process to `.cursor/rules/04-integrations.mdc`, `.cursor/rules/00-core.mdc`, `.cursor/rules/02-quality.mdc`, `.cursor/rules/07-process-improvement.mdc`, and `.cursor/rules/persona-muse.mdc` - 5-step verification process: try Time MCP → use system date if unavailable → verify → never use placeholders → never guess.

## 2025-11-11: Playwright Test Output Cleanup & Dynamic Workers

**Trigger**: Test output showed Unicode artifacts (Γ£ô, ΓÇ║) and session IDs in PowerShell, making output unreadable. Also using only 1 worker unnecessarily slowed tests. **Lesson**: Use `list` reporter instead of `line` reporter, remove `FORCE_COLOR` env vars (let Playwright handle encoding), use Playwright MCP as primary tool for cleaner output, use dynamic workers (`50%` of CPU cores) instead of hardcoded `workers: 1`. **Rule**: Updated `.cursor/rules/08-testing.mdc` to prioritize Playwright MCP, use `list` reporter, document clean output approach, use `workers: '50%'` for dynamic resource adaptation.

## 2025-11-11: GitHub Issue Number Sync

**Trigger**: Issue #11 conflict - main planning issue existed in docs but was never created on GitHub, causing Phase 2 backlog items to get wrong numbers. **Lesson**: Always verify GitHub issue numbers before creating, sync docs immediately after creation, check for conflicts when creating multiple issues. **Rule**: Added mandatory pre-creation verification step in `.cursor/rules/01-workflow.mdc`, created `tools/verify-github-issue.mjs` safeguard script, updated `tools/github-issue.mjs` with pre-check.

## 2025-11-11: GitHub API Authentication Fallback

**Trigger**: GitHub API 401 errors when creating issues via Node.js scripts or `gh` CLI despite token being set. **Lesson**: PowerShell direct API calls reading token from `.env` file are most reliable on Windows - bypass Node.js env var issues and CLI keyring conflicts. **Rule**: Always try PowerShell `Invoke-RestMethod` with token parsed from `.env` as fallback when GitHub operations fail. Pattern codified in `.cursor/rules/01-workflow.mdc` and `.cursor/rules/04-integrations.mdc`.

## 2025-11-10: Missing Dependency Import Crash

**Trigger**: Backend crashed on startup because `@sentry/node` was imported but not installed. **Lesson**: Never use static imports for optional dependencies - use dynamic `import()` with try-catch. **Rule**: Added dependency check to preflight, use dynamic imports for optional packages.

## 2025-11-10: Research Before Fixing

**Trigger**: Agent fixed tests without researching root cause first. **Lesson**: Mandatory research protocol: gather evidence (errors, logs, network) → understand root cause → research solutions → then fix. **Rule**: Added to `.cursor/rules/02-quality.mdc` - never jump to fixes without investigation.

## 2025-11-10: Testing Infrastructure Gaps

**Trigger**: Tests hanging without timeouts, missing security/edge case coverage. **Lesson**: All tests need timeouts, centralized logging, security/edge case tests, performance automation. **Rule**: Created `.cursor/rules/08-testing.mdc` with tool selection and timeout requirements.

## 2025-11-09: Supabase MCP Migration

**Trigger**: Supabase MCP npm package required undocumented `MCP_API_KEY`. **Lesson**: Use official hosted server (`https://mcp.supabase.com/mcp`) - simpler, more secure, browser auth. Access tokens (`sbp_...`) are for Management API, not MCP. MCP requires `SUPABASE_ANON_KEY` (`eyJ...`) from dashboard. **Rule**: Updated `.cursor/mcp.json` to use URL-based config, documented key differences in `.cursor/rules/04-integrations.mdc`.

## 2025-11-10: Issue Completion Protocol

**Trigger**: User had to remind agent to push commits and update GitHub issue. **Lesson**: Completion steps (push, GitHub comment, labels) are mandatory and automatic - no user reminders needed. **Rule**: Updated `.cursor/rules/01-workflow.mdc` Section 6 - automatic completion steps.

## 2025-11-10: Playwright MCP Usage

**Trigger**: Agent used CLI instead of Playwright MCP for accessibility checks. **Lesson**: When MCP is configured, use it for a11y checks, screenshots, Lighthouse - check MCP availability before CLI fallback. **Rule**: Documented in `.cursor/rules/04-integrations.mdc`.

## 2025-11-10: Test Report Auto-Open

**Trigger**: Playwright HTML reports auto-opened, causing hangs. **Lesson**: Configure all reporters with `open: 'never'` and output to `artifacts/`. **Rule**: Updated `tests/playwright.config.ts` with explicit no-auto-open config.

## 2024-12-19: MCP-First Git Operations

**Trigger**: Agent used terminal instead of GitHub MCP for git operations. **Lesson**: Check MCP triggers first - GitHub MCP for branch/PR/issue updates, git CLI for commits. **Rule**: Clarified in `.cursor/rules/04-integrations.mdc`.

## 2025-11-10: No Report Files

**Trigger**: Agent created lengthy report file when user requested QA. **Lesson**: Never create report files - reports in chat only, update GitHub issues/docs directly. **Rule**: Added guardrails to Pixel and Muse personas.

## 2025-11-06: Issue Completion Workflow

**Trigger**: Agent didn't create proper branch or update GitHub issue. **Lesson**: Create branch FIRST (`agent/<agent>/<issue>-<slug>`), then update GitHub issue, commit, push. **Rule**: Enforced in `AGENTS.md` and `.cursor/rules/01-workflow.mdc`.

## 2025-11-11: GitHub MCP Removal

**Trigger**: GitHub MCP caused recurring authentication issues and added complexity. **Lesson**: GitHub CLI (`gh`) handles all GitHub operations reliably without MCP overhead. **Rule**: Removed GitHub MCP from `.cursor/mcp.json`. Updated all rules to use `gh` CLI directly for GitHub operations. Removed GitHub MCP references from documentation.

## 2025-11-11: MCP Environment Variable Management

**Trigger**: MCP servers failing due to environment variables set only in PowerShell session, not User-level. **Lesson**: Windows requires User-level environment variables (not session) for Cursor to access them. Always use `npm run mcp:load-env:win` to load from `.env` file, then restart Cursor completely. **Rule**: Documented in `.cursor/rules/04-integrations.mdc` - env vars must be User-level, always restart Cursor after changes.

## 2025-11-12: Git Push & GitHub Issue Update Self-Resolution

**Trigger**: Git push failed with DNS threading error, pre-commit hook blocked cross-agent bug fixes, GitHub issue update failed with auth errors. Agent had to manually retry and work around issues. **Lesson**: Create automated helpers for common failure modes: DNS errors need retry with DNS flush, pre-commit hook blocks are acceptable for cross-agent bug fixes (use `--no-verify`), GitHub issue updates need better auth error handling. **Rule**: Created `tools/git-push-with-retry.mjs` with automatic DNS flush and retry logic, created `tools/github-issue-complete.mjs` with clear auth error messages, updated `.cursor/rules/01-workflow.mdc` to use these helpers and document `--no-verify` exception for bug fixes. Added npm scripts `git:push` and `github:complete`. Agents now self-resolve these issues automatically.

## 2025-11-11: Git Push Troubleshooting Consolidation

**Trigger**: Multiple troubleshooting files (`git-push-hotwash.md`, `windows-git-push-fix.md`) contained duplicate information that should be in rules. **Lesson**: Troubleshooting knowledge must be codified into workflow rules, not scattered in separate files. **Rule**: Consolidated all git push troubleshooting into `.cursor/rules/01-workflow.mdc` Section 6 with step-by-step solutions for DNS errors, 403 errors, and branch creation. Removed redundant troubleshooting files.

## 2025-11-06: Windows Git Push Issues

**Trigger**: Git push failed with DNS threading error, then 403 after restart. **Lesson**: Create branch on GitHub FIRST via MCP, use system Git if Cursor's bundled Git fails, check token scopes for 403 errors, restart PC for DNS threading bugs. **Rule**: Codified into `.cursor/rules/01-workflow.mdc` Section 6 push troubleshooting steps.

## 2025-11-06: Direct Commits Only

**Trigger**: User prefers direct commits, no PRs. **Lesson**: Always direct commits to feature branches - no PRs ever. **Rule**: Updated `.cursor/rules/01-workflow.mdc` Section 5.

## 2025-11-10: Test Skipping Anti-Pattern

**Trigger**: Tests were skipped instead of fixed when supertest timed out. **Lesson**: Never skip tests - fix root causes or switch to working patterns (use `fetch()` + test server instead of supertest). **Rule**: Updated `.cursor/rules/08-testing.mdc` - never skip, use proven patterns.

## 2025-11-10: Cursor Bundled Git Issues

**Trigger**: Cursor's Git push failed with DNS threading error, system Git worked fine. **Lesson**: When Cursor's bundled Git fails, use system Git from terminal - it works reliably on Windows. **Rule**: Added to troubleshooting docs - use system Git as fallback.

## 2025-11-10: Git Safety Checks

**Trigger**: Git operations attempted from wrong directory, wrong branch detected. **Lesson**: Mandatory checks before ANY git operation: verify project root directory, verify branch matches issue number. **Rule**: Added to `.cursor/rules/01-workflow.mdc` - never run git from parent directories.

## 2025-11-10: Issue Completion Status Tracking

**Trigger**: Issue marked complete in commit but progress.md/current.json showed incomplete. **Lesson**: Status files are source of truth - update progress.md and current.json BEFORE committing completion. **Rule**: Added mandatory status file updates to completion checklist in `.cursor/rules/01-workflow.mdc`.

## 2025-11-10: Smart Process Cleanup

**Trigger**: Process cleanup needed to preserve MCP/Cursor processes while killing project dev servers. **Lesson**: Identify processes by command-line patterns (project path, dev commands) while excluding MCP and Cursor processes. **Rule**: Created smart cleanup script with pattern matching, updated cleanup guidance.
