#!/usr/bin/env bash
# Commit message validation hook
# Install with: cp scripts/hooks/commit-msg.sample .git/hooks/commit-msg && chmod +x .git/hooks/commit-msg

commit_msg=$(cat "$1")

# Allow empty commit messages (for merge commits, etc.)
if [ -z "$commit_msg" ]; then
  exit 0
fi

# Check for conventional commit format
# Pattern: <type>(<scope>): <description>
# Types: feat, fix, chore, docs, refactor, test, style, perf, build, ci, revert
if ! echo "$commit_msg" | grep -qE '^(feat|fix|chore|docs|refactor|test|style|perf|build|ci|revert)(\(.+\))?: .+'; then
  echo "ERROR: Commit message must follow conventional commit format:"
  echo ""
  echo "  <type>: <description>"
  echo ""
  echo "Valid types: feat, fix, chore, docs, refactor, test, style, perf, build, ci, revert"
  echo ""
  echo "Examples:"
  echo "  feat: Complete Issue #123 - Add user authentication"
  echo "  fix: Issue #456 - Resolve memory leak in API"
  echo "  chore: Update dependencies"
  echo "  docs: Update README with setup instructions"
  echo ""
  echo "Your message: $commit_msg"
  exit 1
fi

# For feat/fix commits, recommend issue number reference (warn, don't block)
if echo "$commit_msg" | grep -qE '^(feat|fix):' && ! echo "$commit_msg" | grep -qiE '(issue|#)\s*\d+'; then
  echo ""
  echo "WARNING: Feature/fix commits should reference issue number:"
  echo "  Example: feat: Complete Issue #123 - description"
  echo ""
  echo "Your message: $commit_msg"
  echo ""
  echo "Continue anyway? (y/N)"
  read -r response
  if [[ ! "$response" =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Enforce [no-verify: <reason>] tag when SKIP_* flags are set or hooks are bypassed
# This prevents commits with --no-verify from proceeding without documenting the reason
if [ -n "${SKIP_STATUS:-}" ] || [ -n "${SKIP_LOCK_CHECK:-}" ] || [ -n "${SKIP_PREFLIGHT:-}" ] || [ -n "${GIT_PUSH_NO_VERIFY:-}" ]; then
  if ! echo "$commit_msg" | grep -qE '\[no-verify:[^]]+\]'; then
    echo ""
    echo "ERROR: Commit bypasses hooks (SKIP_* flag or --no-verify detected) but commit message"
    echo "       is missing required [no-verify: <reason>] tag."
    echo ""
    echo "Required format:"
    echo "  git commit -m \"<type>: <description>\" -m \"[no-verify: <reason>]\""
    echo ""
    echo "Examples:"
    echo "  git commit -m \"chore: Update docs\" -m \"[no-verify: SKIP_LOCK_CHECK for workflow hooks]\""
    echo "  git commit -m \"fix: Issue #123\" -m \"[no-verify: Pre-existing preflight issues unrelated to fix]\""
    echo ""
    echo "Your message: $commit_msg"
    echo ""
    echo "Amend the commit message to include the [no-verify: <reason>] tag, or remove SKIP_* flags."
    exit 1
  fi

  # Validate the reason is non-empty
  if echo "$commit_msg" | grep -qE '\[no-verify:\s*\]'; then
    echo ""
    echo "ERROR: [no-verify:] tag found but reason is empty."
    echo ""
    echo "Required format: [no-verify: <concrete reason>]"
    echo ""
    echo "Example: [no-verify: SKIP_LOCK_CHECK needed for workflow hook updates]"
    echo ""
    exit 1
  fi
fi

exit 0

