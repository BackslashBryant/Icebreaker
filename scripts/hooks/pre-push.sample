#!/usr/bin/env bash
# Pre-push hook - Lightweight checks before push
# Install with: cp scripts/hooks/pre-push.sample .git/hooks/pre-push && chmod +x .git/hooks/pre-push

branch="$(git rev-parse --abbrev-ref HEAD)"
remote="${1:-origin}"

echo "[pre-push] Preparing to push to $remote/$branch..."

# Warn about pushing to main/master
if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
  echo "WARNING: Pushing directly to $branch branch."
  echo "Consider using a feature branch and pull request instead."
  read -p "Continue? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
  echo "WARNING: You have uncommitted changes."
  echo "Consider committing or stashing them before pushing."
  read -p "Continue anyway? (y/N) " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
  fi
fi

# Verify branch exists on remote (or will be created)
remote_branch="refs/heads/$branch"
if ! git ls-remote --heads "$remote" "$branch" | grep -q "$remote_branch"; then
  echo "[pre-push] Branch $branch doesn't exist on $remote. Will be created on push."
else
  echo "[pre-push] Branch $branch exists on $remote. Will update."
fi

# Check merge base with main (branch readiness) - STRICT
echo "[pre-push] Checking merge base with main..."
if [ "$branch" != "main" ] && [ "$branch" != "master" ]; then
  if git fetch origin main >/dev/null 2>&1; then
    MERGE_BASE=$(git merge-base HEAD origin/main 2>/dev/null || echo "")
    MAIN_HEAD=$(git rev-parse origin/main 2>/dev/null || echo "")
    
    if [ -n "$MERGE_BASE" ] && [ -n "$MAIN_HEAD" ]; then
      COMMITS_BEHIND=$(git rev-list --count "$MERGE_BASE".."$MAIN_HEAD" 2>/dev/null || echo "0")
      
      if [ "$COMMITS_BEHIND" -gt 10 ]; then
        echo "ERROR: Branch is $COMMITS_BEHIND commits behind main."
        echo "  Merge base: $(git rev-parse --short $MERGE_BASE)"
        echo "  Main HEAD:  $(git rev-parse --short $MAIN_HEAD)"
        echo ""
        echo "REQUIRED: Rebase on main before pushing: git rebase origin/main"
        echo "This ensures CI tests run against current main state."
        exit 1
      elif [ "$COMMITS_BEHIND" -gt 0 ]; then
        echo "WARNING: Branch is $COMMITS_BEHIND commits behind main."
        echo "Consider rebasing: git rebase origin/main"
      fi
    fi
  fi
fi

# Log --no-verify usage if detected
if [ -n "$GIT_PUSH_NO_VERIFY" ] || echo "$*" | grep -q "no-verify"; then
  echo "[pre-push] WARNING: --no-verify detected. Logging reason..."
  REASON_FILE=".git/no-verify-log.txt"
  TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
  echo "[$TIMESTAMP] Branch: $branch | Reason: ${GIT_PUSH_NO_VERIFY_REASON:-Not specified}" >> "$REASON_FILE"
  echo "[pre-push] --no-verify logged. Reason should be documented in commit message."
fi

# Quick lint check on files being pushed (lightweight)
echo "[pre-push] Running quick lint check..."
if command -v npm >/dev/null 2>&1 && [ -f "package.json" ]; then
  # Only check files that changed between local and remote
  if git rev-parse --verify "$remote/$branch" >/dev/null 2>&1; then
    changed_files=$(git diff --name-only "$remote/$branch"..HEAD | grep -E '\.(js|jsx|ts|tsx|mjs)$' || true)
    if [ -n "$changed_files" ] && [ -f "node_modules/.bin/eslint" ]; then
      echo "[pre-push] Checking changed files..."
      if ! npx eslint --max-warnings=10 $changed_files 2>/dev/null; then
        echo "Linting issues found. Fix them or push with --no-verify to bypass."
        read -p "Continue anyway? (y/N) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
          exit 1
        fi
      fi
    fi
  fi
fi

# Validate workflow guardrails (matrix/config, browser deps)
echo "[pre-push] Validating workflow guardrails..."
if command -v node >/dev/null 2>&1; then
  if [ -f "tools/validate-matrix-config.mjs" ]; then
    if ! node tools/validate-matrix-config.mjs >/dev/null 2>&1; then
      echo "WARNING: Matrix/config validation failed. Run: node tools/validate-matrix-config.mjs"
      read -p "Continue anyway? (y/N) " -n 1 -r
      echo
      if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
      fi
    fi
  fi
  
  if [ -f "tools/validate-browser-deps.mjs" ]; then
    if ! node tools/validate-browser-deps.mjs >/dev/null 2>&1; then
      echo "WARNING: Browser dependency validation failed. Run: node tools/validate-browser-deps.mjs"
      read -p "Continue anyway? (y/N) " -n 1 -r
      echo
      if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
      fi
    fi
  fi
fi

echo "[pre-push] Pre-push checks passed."

